<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Podcast Stream</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        
        .container { max-width: 1600px; margin: 0 auto; }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e74c3c;
        }
        
        .header h1 { font-size: 36px; color: #2c3e50; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 16px; }
        
        /* Controls */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .search-bar:focus { outline: none; border-color: #e74c3c; }
        
        .filters, .sort-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .filter-btn, .sort-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .filter-btn:hover, .sort-btn:hover { border-color: #e74c3c; color: #e74c3c; }
        .filter-btn.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        
        .sort-label { font-weight: 600; color: #555; align-self: center; }
        
        /* THREE COLUMN LAYOUT */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .video-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
        }
        
        .video-card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
        
        /* Badges */
        .badge {
            position: absolute;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .new-badge { top: 10px; right: 10px; background: #e74c3c; color: white; }
        .trending-badge { top: 10px; left: 10px; background: #f39c12; color: white; }
        .episode-badge { top: 45px; right: 10px; background: #9b59b6; color: white; }
        .engagement-badge { top: 80px; right: 10px; background: #27ae60; color: white; }
        .views-per-day-badge { top: 115px; right: 10px; background: #3498db; color: white; }
        
        .duration-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 15;
        }
        
        /* Thumbnail with embedded playback */
        .video-thumbnail {
            position: relative;
            padding-bottom: 56.25%;
            background: #000;
            cursor: pointer;
        }
        
        .video-thumbnail img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-thumbnail.playing img {
            display: none;
        }
        
        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: rgba(231, 76, 60, 0.9);
            border-radius: 50%;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .play-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 52%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 18px solid white;
            border-top: 11px solid transparent;
            border-bottom: 11px solid transparent;
        }
        
        .play-button:hover { background: rgba(231, 76, 60, 1); transform: translate(-50%, -50%) scale(1.1); }
        
        .video-thumbnail.playing .play-button {
            display: none;
        }
        
        /* Content */
        .video-content { padding: 20px; }
        
        .video-title {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .video-title a {
            color: #2c3e50;
            text-decoration: none;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .video-title a:hover { color: #e74c3c; }
        
        .video-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .channel-name {
            font-weight: 600;
            color: #e74c3c;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .channel-name:hover { 
            color: #c0392b;
            text-decoration: underline; 
        }
        
        .video-duration {
            font-weight: 600;
            color: #555;
        }
        
        .stats-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 11px;
        }
        
        .stat-item { display: flex; align-items: center; gap: 4px; }
        
        .topic-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .topic-tag {
            padding: 3px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .topic-tag:hover {
            background: #bbdefb;
        }
        
        .player-mentions, .team-mentions {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
            padding: 6px 8px;
            border-radius: 4px;
        }
        
        .player-mentions {
            background: #fff3cd;
        }
        
        .team-mentions {
            background: #d1ecf1;
        }
        
        .clickable-name {
            color: #0056b3;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
            transition: color 0.2s;
        }
        
        .clickable-name:hover {
            color: #003d82;
        }
        
        .video-description {
            font-size: 12px;
            line-height: 1.5;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-left: 3px solid #e74c3c;
            border-radius: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .video-summary {
            font-size: 13px;
            line-height: 1.5;
            color: #555;
            margin-top: 10px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .summary-label { font-weight: 600; color: #2980b9; margin-bottom: 5px; }
        
        .freshness-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        
        .fresh { background: #d4edda; color: #155724; }
        .recent { background: #fff3cd; color: #856404; }
        .older { background: #f8d7da; color: #721c24; }
        
        .loading-spinner, .loading, .error, .no-videos {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .error { color: #e74c3c; }
        
        @media (max-width: 1400px) {
            .video-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 900px) {
            .video-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 28px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ NBA Podcast Stream</h1>
            <p>Latest episodes with AI summaries and insights</p>
        </div>

        <div class="controls">
            <input 
                type="text" 
                class="search-bar" 
                id="searchBar" 
                placeholder="üîç Search title, channel, description, topics, players, teams..."
            >
            
            <div class="filters">
                <button class="filter-btn active" data-filter="all">All Episodes</button>
                <button class="filter-btn" data-filter="summaries">With AI Summaries</button>
                <button class="filter-btn" data-filter="trending">üî• Trending</button>
                <button class="filter-btn" data-filter="new">üÜï New Today</button>
            </div>

            <div class="sort-controls">
                <span class="sort-label">Sort:</span>
                <button class="sort-btn active" data-sort="date">Latest</button>
                <button class="sort-btn" data-sort="views">Most Viewed</button>
                <button class="sort-btn" data-sort="channel">Channel A-Z</button>
            </div>
        </div>

        <div id="videoGrid" class="video-grid">
            <div class="loading">Loading episodes...</div>
        </div>

        <div class="loading-spinner" id="loadingSpinner" style="display: none;">
            Loading more...
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRr8GiFRfKLquD0j49JqKIL11tnulG7--WeJsvP3nqFc72EeQM3RsQjnWeXlgcVoR2RL5y7oqYbfpSs/pub?gid=162816128&single=true&output=csv';
        const ITEMS_PER_LOAD = 15;
        
        // More specific NBA player names to avoid false positives
        const NBA_PLAYERS = {
            'LeBron James': 'LeBron James',
            'LeBron': 'LeBron James',
            'Stephen Curry': 'Stephen Curry',
            'Steph Curry': 'Stephen Curry',
            'Curry': 'Stephen Curry',
            'Kevin Durant': 'Kevin Durant',
            'KD': 'Kevin Durant',
            'Durant': 'Kevin Durant',
            'Giannis Antetokounmpo': 'Giannis Antetokounmpo',
            'Giannis': 'Giannis Antetokounmpo',
            'Nikola Jokic': 'Nikola Jokic',
            'Jokic': 'Nikola Jokic',
            'Joel Embiid': 'Joel Embiid',
            'Embiid': 'Joel Embiid',
            'Jayson Tatum': 'Jayson Tatum',
            'Tatum': 'Jayson Tatum',
            'Luka Doncic': 'Luka Doncic',
            'Luka': 'Luka Doncic',
            'James Harden': 'James Harden',
            'Harden': 'James Harden',
            'Devin Booker': 'Devin Booker',
            'Booker': 'Devin Booker',
            'Anthony Davis': 'Anthony Davis',
            'AD': 'Anthony Davis',
            'Jimmy Butler': 'Jimmy Butler',
            'Butler': 'Jimmy Butler',
            'Damian Lillard': 'Damian Lillard',
            'Dame': 'Damian Lillard',
            'Donovan Mitchell': 'Donovan Mitchell',
            'Mitchell': 'Donovan Mitchell',
            'Trae Young': 'Trae Young',
            'Ja Morant': 'Ja Morant',
            'Morant': 'Ja Morant',
            'Anthony Edwards': 'Anthony Edwards',
            'Ant Edwards': 'Anthony Edwards',
            'Victor Wembanyama': 'Victor Wembanyama',
            'Wembanyama': 'Victor Wembanyama',
            'Wemby': 'Victor Wembanyama',
            'Shaquille O\'Neal': 'Shaquille O\'Neal',
            'Shaq': 'Shaquille O\'Neal',
            'Michael Jordan': 'Michael Jordan',
            'MJ': 'Michael Jordan',
            'Kobe Bryant': 'Kobe Bryant',
            'Kobe': 'Kobe Bryant'
        };
        
        const NBA_TEAMS = ['Lakers', 'Warriors', 'Celtics', 'Heat', 'Bucks', 'Nuggets', 'Suns', 'Mavericks', 'Sixers', '76ers', 'Knicks', 'Clippers', 'Kings', 'Grizzlies', 'Cavaliers', 'Thunder', 'Timberwolves', 'Spurs'];
        const TOPICS = ['Trade', 'Playoff', 'Draft', 'MVP', 'Championship', 'Finals', 'Injury', 'Analysis', 'Recap', 'Preview', 'Breaking', 'Rumor'];
        
        let allVideos = [];
        let filteredVideos = [];
        let displayedCount = ITEMS_PER_LOAD;
        let currentFilter = 'all';
        let currentSort = 'date';
        let searchQuery = '';
        let isLoading = false;
        let channelFilter = null;
        let players = {}; // YouTube player instances
        let currentPlayingId = null;
        
        function formatNumber(num) {
            const n = parseInt(num);
            if (isNaN(n)) return num;
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Unknown';
                return date.toLocaleString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true
                });
            } catch { return 'Unknown'; }
        }
        
        function parseDuration(duration) {
            if (!duration) return 0;
            const parts = duration.split(':').map(Number);
            if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
            if (parts.length === 2) return parts[0] * 60 + parts[1];
            return 0;
        }
        
        function getAgeInHours(dateString) {
            try {
                return (new Date() - new Date(dateString)) / (1000 * 60 * 60);
            } catch { return 999; }
        }
        
        function isNew(dateString) { return getAgeInHours(dateString) < 24; }
        function isTrending(viewCount) { return parseInt(viewCount) > 50000; }
        
        function calculateEngagement(video) {
            const views = parseInt(video.viewCount) || 0;
            const likes = parseInt(video.likeCount) || 0;
            return views > 0 ? (likes / views) * 100 : 0;
        }
        
        function calculateViewsPerDay(video) {
            const views = parseInt(video.viewCount) || 0;
            const ageHours = getAgeInHours(video.publishedDate);
            const ageDays = Math.max(ageHours / 24, 0.1); // Minimum 0.1 days
            return Math.round(views / ageDays);
        }
        
        function getFreshnessIndicator(dateString) {
            const hours = getAgeInHours(dateString);
            if (hours < 6) return '<span class="freshness-indicator fresh">üî¥ LIVE FRESH</span>';
            if (hours < 24) return '<span class="freshness-indicator recent">üü° NEW</span>';
            return '';
        }
        
        function extractEpisode(title) {
            const patterns = [/ep\.?\s*#?(\d+)/i, /episode\s*#?(\d+)/i, /#(\d+)/, /\[(\d+)\]/, /\((\d+)\)/];
            for (const pattern of patterns) {
                const match = title.match(pattern);
                if (match) return `EP ${match[1]}`;
            }
            return null;
        }
        
        function extractTopics(text) {
            if (!text) return [];
            return TOPICS.filter(t => text.toLowerCase().includes(t.toLowerCase())).slice(0, 5);
        }
        
        function detectPlayers(text) {
            if (!text) return {};
            const mentions = {};
            const textLower = text.toLowerCase();
            
            // First pass - look for full names
            Object.entries(NBA_PLAYERS).forEach(([key, fullName]) => {
                if (key.includes(' ')) { // Full name like "LeBron James"
                    const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        mentions[fullName] = (mentions[fullName] || 0) + matches.length;
                    }
                }
            });
            
            // Second pass - look for short names only if full name not found
            Object.entries(NBA_PLAYERS).forEach(([key, fullName]) => {
                if (!key.includes(' ') && !mentions[fullName]) { // Short name like "LeBron"
                    const regex = new RegExp('\\b' + key + '\\b', 'gi');
                    const matches = text.match(regex);
                    if (matches) {
                        mentions[fullName] = (mentions[fullName] || 0) + matches.length;
                    }
                }
            });
            
            return mentions;
        }
        
        function detectTeams(text) {
            if (!text) return [];
            return [...new Set(NBA_TEAMS.filter(team => text.toLowerCase().includes(team.toLowerCase())))];
        }
        
        function filterByChannel(channelName) {
            channelFilter = channelFilter === channelName ? null : channelName;
            filterVideos();
        }
        
        function filterByName(name) {
            searchQuery = name;
            document.getElementById('searchBar').value = name;
            filterVideos();
        }
        
        function filterByTopic(topic) {
            searchQuery = topic;
            document.getElementById('searchBar').value = topic;
            filterVideos();
        }
        
        // YouTube Player API Ready
        let YTReady = false;
        function onYouTubeIframeAPIReady() {
            YTReady = true;
        }
        
        function playVideo(videoId, cardIndex, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const card = document.querySelectorAll('.video-card')[cardIndex];
            const thumbnail = card.querySelector('.video-thumbnail');
            const playerId = `player-${videoId}`;
            
            // Remove existing player div if any
            let playerDiv = thumbnail.querySelector(`#${playerId}`);
            if (!playerDiv) {
                playerDiv = document.createElement('div');
                playerDiv.id = playerId;
                playerDiv.style.position = 'absolute';
                playerDiv.style.top = '0';
                playerDiv.style.left = '0';
                playerDiv.style.width = '100%';
                playerDiv.style.height = '100%';
                thumbnail.appendChild(playerDiv);
            }
            
            thumbnail.classList.add('playing');
            currentPlayingId = videoId;
            
            // Create YouTube player
            if (YTReady && !players[videoId]) {
                players[videoId] = new YT.Player(playerId, {
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1,
                        'modestbranding': 1,
                        'rel': 0
                    },
                    events: {
                        'onStateChange': function(event) {
                            if (event.data === YT.PlayerState.ENDED) {
                                playNextVideo(cardIndex);
                            }
                        }
                    }
                });
            } else if (!YTReady) {
                // Fallback to iframe if API not ready
                playerDiv.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            }
        }
        
        function playNextVideo(currentIndex) {
            const nextIndex = currentIndex + 1;
            const cards = document.querySelectorAll('.video-card');
            
            if (nextIndex < cards.length) {
                // Scroll to next card
                cards[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Play after short delay
                setTimeout(() => {
                    const playButton = cards[nextIndex].querySelector('.video-thumbnail');
                    if (playButton) {
                        // Simulate click on thumbnail
                        const video = filteredVideos[nextIndex];
                        playVideo(video.id, nextIndex, { preventDefault: () => {}, stopPropagation: () => {} });
                    }
                }, 1000);
            }
        }
        
        function createVideoCard(video, index) {
            const engagement = calculateEngagement(video);
            const viewsPerDay = calculateViewsPerDay(video);
            const episodeNum = extractEpisode(video.title);
            
            const fullText = `${video.title} ${video.description}`;
            const topics = extractTopics(fullText);
            const playerMentions = detectPlayers(fullText);
            const teams = detectTeams(fullText);
            
            const topPlayers = Object.entries(playerMentions).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            const card = document.createElement('div');
            card.className = 'video-card';
            
            // Build stats row - hide subscribers if N/A
            let statsHtml = `<div class="stat-item">üëÅÔ∏è <strong>${formatNumber(video.viewCount)}</strong></div>`;
            if (video.subscriberCount !== 'N/A' && video.subscriberCount !== 'Hidden') {
                statsHtml += `<div class="stat-item">üë• <strong>${formatNumber(video.subscriberCount)}</strong></div>`;
            }
            if (video.likeCount !== '0') {
                statsHtml += `<div class="stat-item">üëç <strong>${formatNumber(video.likeCount)}</strong></div>`;
            }
            if (video.commentCount !== '0') {
                statsHtml += `<div class="stat-item">üí¨ <strong>${formatNumber(video.commentCount)}</strong></div>`;
            }
            
            card.innerHTML = `
                ${isNew(video.publishedDate) ? '<div class="badge new-badge">NEW</div>' : ''}
                ${isTrending(video.viewCount) ? '<div class="badge trending-badge">üî• TRENDING</div>' : ''}
                ${episodeNum ? `<div class="badge episode-badge">${episodeNum}</div>` : ''}
                ${engagement > 5 ? `<div class="badge engagement-badge">‚≠ê ${engagement.toFixed(1)}%</div>` : ''}
                ${viewsPerDay > 10000 ? `<div class="badge views-per-day-badge">üöÄ ${formatNumber(viewsPerDay)}/day</div>` : ''}
                
                <div class="video-thumbnail" onclick="playVideo('${video.id}', ${index}, event)">
                    <img src="${video.thumbnail}" alt="${video.title.replace(/"/g, '&quot;')}">
                    ${video.duration ? `<div class="duration-badge">‚è±Ô∏è ${video.duration}</div>` : ''}
                    <div class="play-button"></div>
                </div>
                
                <div class="video-content">
                    <h3 class="video-title">
                        <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank">${video.title}</a>
                    </h3>
                    <div class="video-meta">
                        <span class="channel-name" onclick="filterByChannel('${video.channelName.replace(/'/g, "\\'")}')">${video.channelName}</span>
                        <span>üìÖ ${formatDate(video.publishedDate)}</span>
                        ${getFreshnessIndicator(video.publishedDate)}
                    </div>
                    ${video.duration ? `<div class="video-duration">‚è±Ô∏è Duration: <strong>${video.duration}</strong></div>` : ''}
                    <div class="stats-row">
                        ${statsHtml}
                    </div>
                    ${topics.length > 0 ? `<div class="topic-tags">${topics.map(t => `<span class="topic-tag" onclick="filterByTopic('${t}')">#${t}</span>`).join('')}</div>` : ''}
                    ${topPlayers.length > 0 ? `<div class="player-mentions">üèÄ ${topPlayers.map(([name, count]) => `<span class="clickable-name" onclick="filterByName('${name.replace(/'/g, "\\'")}')">${name}</span> (${count})`).join(', ')}</div>` : ''}
                    ${teams.length > 0 ? `<div class="team-mentions">üèÜ ${teams.slice(0, 3).map(team => `<span class="clickable-name" onclick="filterByName('${team}')">${team}</span>`).join(', ')}</div>` : ''}
                    ${video.description ? `<div class="video-description">${video.description.substring(0, 200)}...</div>` : ''}
                    ${video.summary ? `<div class="video-summary"><div class="summary-label">ü§ñ AI Summary:</div>${video.summary}</div>` : ''}
                </div>
            `;
            
            return card;
        }
        
        function filterVideos() {
            let result = allVideos;
            
            if (channelFilter) {
                result = result.filter(v => v.channelName === channelFilter);
            }
            
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                result = result.filter(v => {
                    const fullText = `${v.title} ${v.channelName} ${v.description}`.toLowerCase();
                    const topics = extractTopics(fullText).join(' ').toLowerCase();
                    const playerNames = Object.keys(detectPlayers(fullText)).join(' ').toLowerCase();
                    const teamNames = detectTeams(fullText).join(' ').toLowerCase();
                    return fullText.includes(query) || topics.includes(query) || playerNames.includes(query) || teamNames.includes(query);
                });
            }
            
            switch(currentFilter) {
                case 'summaries': 
                    result = result.filter(v => v.transcriptAvailable === 'Yes' && v.summary && v.summary.trim().length > 0); 
                    break;
                case 'trending': 
                    result = result.filter(v => isTrending(v.viewCount)); 
                    break;
                case 'new': 
                    result = result.filter(v => isNew(v.publishedDate)); 
                    break;
            }
            
            switch(currentSort) {
                case 'views': 
                    result.sort((a, b) => parseInt(b.viewCount) - parseInt(a.viewCount)); 
                    break;
                case 'channel': 
                    result.sort((a, b) => a.channelName.localeCompare(b.channelName)); 
                    break;
                default: 
                    result.sort((a, b) => new Date(b.publishedDate) - new Date(a.publishedDate));
            }
            
            filteredVideos = result;
            displayedCount = ITEMS_PER_LOAD;
            renderVideos();
        }
        
        function renderVideos() {
            const grid = document.getElementById('videoGrid');
            const videosToShow = filteredVideos.slice(0, displayedCount);
            
            if (videosToShow.length === 0) {
                grid.innerHTML = '<div class="no-videos">No episodes found matching your criteria.</div>';
                return;
            }
            
            grid.innerHTML = '';
            videosToShow.forEach((video, i) => {
                const card = createVideoCard(video, i);
                grid.appendChild(card);
            });
        }
        
        function handleScroll() {
            if (isLoading) return;
            const scrollPos = window.innerHeight + window.scrollY;
            const pageHeight = document.documentElement.scrollHeight;
            
            if (scrollPos >= pageHeight - 500 && displayedCount < filteredVideos.length) {
                isLoading = true;
                document.getElementById('loadingSpinner').style.display = 'block';
                setTimeout(() => {
                    displayedCount += ITEMS_PER_LOAD;
                    renderVideos();
                    isLoading = false;
                    document.getElementById('loadingSpinner').style.display = 'none';
                }, 500);
            }
        }
        
        async function loadVideos() {
            try {
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                if (!parsed.data || parsed.data.length === 0) {
                    document.getElementById('videoGrid').innerHTML = '<div class="no-videos">No videos yet.</div>';
                    return;
                }
                
                allVideos = parsed.data.map(row => ({
                    id: row['Video ID'],
                    title: row['Title'],
                    channelName: row['Channel Name'],
                    channelId: row['Channel ID'],
                    publishedDate: row['Published Date'],
                    thumbnail: row['Thumbnail URL'],
                    description: row['Description'] || '',
                    viewCount: row['View Count'] || '0',
                    subscriberCount: row['Subscriber Count'] || 'N/A',
                    duration: row['Duration'] || '',
                    likeCount: row['Like Count'] || '0',
                    commentCount: row['Comment Count'] || '0',
                    transcriptAvailable: row['Transcript Available'] || 'No',
                    summary: row['AI Summary'] || ''
                })).filter(v => v.id);
                
                filterVideos();
            } catch (error) {
                document.getElementById('videoGrid').innerHTML = `<div class="error">Unable to load: ${error.message}</div>`;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadVideos();
            
            let searchTimeout;
            document.getElementById('searchBar').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = e.target.value;
                    channelFilter = null;
                    filterVideos();
                }, 300);
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    filterVideos();
                });
            });
            
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentSort = btn.dataset.sort;
                    filterVideos();
                });
            });
            
            window.addEventListener('scroll', handleScroll);
        });
        
        setInterval(loadVideos, 60 * 60 * 1000);
    </script>
</body>
</html>
